### Introduction

[Event Tracing for Windows](https://learn.microsoft.com/en-us/windows-hardware/drivers/devtest/event-tracing-for-windows--etw-) or ETW, is a powerful tracing mechanism built into the Windows OS which allows for collecting detailed information about events and activities that occur on the system. Events are generated from within the system itself whether executed by the OS (e.g. loading a DLL) or by the user (e.g. opening a file).

In addition, events are generated by both user-mode applications and kernel-mode drivers and subsequently recorded in log files. These log files can be retrieved and examined to gain insight into events that occurred on the system. With that being said, ETW is considered an invaluable source of information for defenders when analyzing breaches and attempting to understand the techniques used by the attackers.

Moreover, security solutions will commonly subscribe to ETW events to detect and prevent attackers in real-time. These solutions will use different algorithms and rules to determine whether an event is considered malicious.

### ETW Architecture

Based on [Microsoft's documentation](https://learn.microsoft.com/en-us/windows-hardware/test/weg/instrumenting-your-code-with-etw#etw-architecture), ETW is constructed from four main components:

- **Providers** - Providers are the top-level entities in the ETW hierarchy. They are responsible for generating events and can be a user-mode application, a kernel-mode driver, or the Windows kernel itself. Each provider is represented by a unique GUID. A system's ETW providers can be listed by executing `logman query providers` in the Windows command line. The image below shows a truncated output of this command. The `logman` command line tool will be explained further in the next module.

![](https://maldevacademy.s3.amazonaws.com/new/update-three/etw-into-45.png)  

- **Tracing session** - A tracing session represents a logical container for capturing and managing events from one or more ETW providers. It provides a centralized context where events are collected, filtered, and processed. In [Microsoft's own words](https://learn.microsoft.com/en-us/windows-hardware/test/weg/instrumenting-your-code-with-etw#session): "A session is a kernel object that collects events into a kernel buffer and sends them to a specified file or real-time consumer process". Tracing sessions can be queried using the `logman query -ets` command, which outputs the results shown below.

![](https://maldevacademy.s3.amazonaws.com/new/update-three/etw-into-56.png)  

- **Controllers** - Controllers are responsible for managing and controlling ETW tracing sessions by allowing the user to start, stop, and configure them. When a tracing session is enabled, a specific ETW provider can begin sending events to it, which can then be read by _ETW consumers_.

- **Consumers** - As mentioned earlier, ETW consumers are applications that connect to an ETW tracing session and read events written to it that are supplied by one or more providers. A tracing session can be found running without any ETW consumer connected to it. Additionally, one ETW consumer can be connected to one or more tracing sessions, allowing it to read more than one type of logged event (e.g. network events and system events).

#### ETW Architecture Diagram

The following image depicts the interconnection of the ETW architecture. It is important to note that _trace files_ have a `.etl` file extension and are produced by enabled ETW trace sessions. These files store the events that are recorded by the provider during the session.

![](https://maldevacademy.s3.amazonaws.com/new/update-three/etw-into-74.png)

### Interacting With ETW

The ETW components are built into the Windows OS kernel, providing the infrastructure for event-based tracing and logging. ETW functionality is exposed to user-mode applications through a set of WinAPIs allowing developers to interact with the ETW infrastructure and utilize its tracing capabilities. User-mode applications can make use of the [ETW WinAPIs](https://learn.microsoft.com/en-us/windows/win32/api/_etw/) to register and unregister ETW providers, write events to the trace session, and configure events to be logged. Some of the ETW WinAPIs are:

- [EventWrite](https://learn.microsoft.com/en-us/windows/win32/api/evntprov/nf-evntprov-eventwrite) and [EventWriteEx](https://learn.microsoft.com/en-us/windows/win32/api/evntprov/nf-evntprov-eventwriteex) - Write an event to the ETW event stream. These WinAPIs are also named `EtwEventWrite` and `EtwEventWriteEx`, respectively.
    
- [StartTraceA](https://learn.microsoft.com/en-us/windows/win32/api/evntrace/nf-evntrace-starttracea) and [StopTraceA](https://learn.microsoft.com/en-us/windows/win32/api/evntrace/nf-evntrace-stoptracea) - Start and stop an ETW tracing session.
    
- [QueryAllTraces](https://learn.microsoft.com/en-us/windows/win32/api/evntrace/nf-evntrace-queryalltracesa) - Retrieves the properties for all running ETW tracing sessions.
    

ETW evasion techniques can be constructed by altering the execution path of these WinAPIs by either patching or hooking these functions. It is worth mentioning that the ETW functions are often exported from the `Advapi32` DLL.

### Kernel-level ETW

`ntoskrnl.exe`, also known as _Windows NT Operating System Kernel Executable_, contains the kernel and executive layers of the Microsoft Windows NT kernel and is responsible for hardware abstraction, process handling, and memory management. The kernel implementation of ETW is done via the `EtwTi` functions, where `Ti` represents "threat intelligence".

The `ntoskrnl.exe` binary can be analyzed from within the [IDA disassembler](https://hex-rays.com/ida-free/) to find out where the `EtwTi` functions are called. The function being analyzed in this example is `MiReadWriteVirtualMemory`, which is called from within the `NtReadVirtualMemory`, `NtWriteVirtualMemory`, and `NtReadVirtualMemoryEx` syscalls.

![](https://maldevacademy.s3.amazonaws.com/new/update-three/etw-intro-246533861-70948a28-5e0c-43ea-9451-7b69c7a7ec2b.png)

The image below shows a snippet of `MiReadWriteVirtualMemory` from within IDA.

![](https://maldevacademy.s3.amazonaws.com/new/update-three/ETW-intro-IDA.png)

Notice how `MiReadWriteVirtualMemory` calls `EtwTiLogReadWriteVm` which logs read and write operations and is one of several `EtwTi` functions called from within the Windows kernel.

![](https://maldevacademy.s3.amazonaws.com/new/update-three/etw-intro-146534042-c4f0130b-2c2e-4ce7-8d7d-dc85a946ce56.png)

#### Additional EtwTi Functions

Searching for the `EtwTi` prefix in IDA will show other similar functions, as shown in the image below.

![](https://maldevacademy.s3.amazonaws.com/new/update-three/etw-intro-346534209-71cbc075-700f-41f9-9585-34a1c6c919c3.png)

The name of the `EtwTi` function will generally indicate what's being logged. A few examples are provided below to further clarify this point.

- `EtwTiLogSetContextThread` - This function is called from the `PspSetContextThreadInternal` and `PspWow64SetContextThread` kernel functions. This `EtwTi` function is triggered when updating a thread's context.
    
- `EtwTiLogSuspendResumeProcess` - This function is called from multiple kernel functions, from which the `PsMultiResumeProcess` and `PsSuspendProcess` functions are the most interesting. This `EtwTi` function is triggered when suspending or resuming a process.
    
- `EtwTiLogAllocExecVm` - This function is called from the `MiAllocateVirtualMemory` kernel function. This `EtwTi` function is triggered when allocating executable memory.
    
- `EtwTiLogProtectExecVm` - This function is called from the `NtProtectVirtualMemory` syscall (in the kernel). This `EtwTi` function is triggered when updating memory permissions to executable.
    

### Bypassing EtwTi Logging

Avoiding threat intelligence ETW logging from user-mode is not an easy task as it would generally require access from kernel mode. Later modules will address techniques for circumventing this form of ETW logging. However, it is strongly advised to review the [Introduction to Threat Intelligence ETW](https://undev.ninja/introduction-to-threat-intelligence-etw/) and [Uncovering Windows Events](https://posts.specterops.io/uncovering-windows-events-b4b9db7eac54) blog posts to gain a deeper understanding of threat intelligence ETW.

### Conclusion

Having completed this module, one should have a fundamental understanding of ETW, including the functions and roles of each component. The subsequent module will focus on interacting with the ETW components using different tools.