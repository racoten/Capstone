# 2.0 Undocumented Structures

### Introduction

When referencing the Windows documentation for a structure, one may encounter several _reserved_ members within the structure. These reserved members are often presented as arrays of `BYTE` or `PVOID` data types. This practice is implemented by Microsoft to maintain confidentiality and prevent users from understanding the structure to avoid modifications to these reserved members.

With that being said, throughout this course, it will be necessary to work with these undocumented members. Therefore, some modules will avoid using Microsoft's documentation and instead use other websites that have the full undocumented structure, which was likely derived through reverse engineering.

### PEB Structure Example

As mentioned in an earlier module, the Process Environment Block or PEB is a data structure that holds information about a Windows process. However, [Microsoft's documentation](https://learn.microsoft.com/en-us/windows/win32/api/winternl/ns-winternl-peb) on the PEB structure shows several reserved members. This makes it difficult to access the members of the structure.

```c
typedef struct _PEB {
  BYTE                          Reserved1[2];
  BYTE                          BeingDebugged;
  BYTE                          Reserved2[1];
  PVOID                         Reserved3[2];
  PPEB_LDR_DATA                 Ldr;
  PRTL_USER_PROCESS_PARAMETERS  ProcessParameters;
  PVOID                         Reserved4[3];
  PVOID                         AtlThunkSListPtr;
  PVOID                         Reserved5;
  ULONG                         Reserved6;
  PVOID                         Reserved7;
  ULONG                         Reserved8;
  ULONG                         AtlThunkSListPtr32;
  PVOID                         Reserved9[45];
  BYTE                          Reserved10[96];
  PPS_POST_PROCESS_INIT_ROUTINE PostProcessInitRoutine;
  BYTE                          Reserved11[128];
  PVOID                         Reserved12[1];
  ULONG                         SessionId;
} PEB, *PPEB;
```

#### Finding Reserved Members

One way to determine what the PEB's reserved members hold is through the `!peb` command in [WinDbg](https://learn.microsoft.com/en-us/windows-hardware/drivers/debugger/debugger-download-tools).

![image](https://maldevacademy.s3.amazonaws.com/images/Basic/undocumented-structs-1224531910-413779d5-2e1d-4813-a545-c690892da2bd.png)

For a more complete PEB structure, refer to Process Hacker's [PEB structure](https://github.com/winsiderss/systeminformer/blob/master/phnt/include/ntpebteb.h#L56).

### Alternative Documentation

As previously mentioned, some modules will avoid using Microsoft's documentation and instead use other documentation sources.

- [Process Hacker's Header Files](https://github.com/winsiderss/systeminformer/tree/master/phnt/include)
    
- [undocumented.ntinternals.net](https://web.archive.org/web/20230401045934/http://undocumented.ntinternals.net/) - Some structures may be outdated
    
- [ReactOS's Documentation](https://doxygen.reactos.org/globals_type.html)
    
- [Vergilius Project](https://www.vergiliusproject.com/) - Although mainly for Windows kernel structures, it remains a valuable resource.
    

### Considerations

When choosing a structure definition, it's important to be mindful of the following points.

- Some structure definitions only work for a specific architecture, either x86 or x64. If that's the case, ensure the appropriate structure definition is chosen.
    
- In certain cases, it may be necessary to define multiple structures due to the concept of nested structures. For example, a structure such as PEB may contain a member that acts as a pointer to another structure. Therefore, it becomes important to include the definition of the latter structure to ensure its correctly interpreted by the program.
    
- When using a custom definition of a structure, it is not possible to include its original definition found in the Windows SDK simultaneously. For example, Microsoft's definition of the PEB structure is located in [Winternl.h](https://learn.microsoft.com/en-us/windows/win32/api/winternl/#structures). If one intends to use a different definition from one of the above-mentioned documentation sources, then attempting to include `Winternl.h` in the program will result in redefinition errors thrown by Visual Studio's compiler. To avoid this, select only one definition of the structure.