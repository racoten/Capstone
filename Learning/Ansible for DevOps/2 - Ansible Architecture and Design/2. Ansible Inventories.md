
Inside `diveintoansible/Ansible Architecture and Design/Inventories/01`, there are 2 files:
- `ansible.cfg`
- `hosts`

# Configurations and Modules
`ansible.cfg` contains simple configurations, in this case it is specifying the list of inventories it contains:
```bash
[default]
inventory = hosts
```

`hosts` contains a list of hosts that we want to interact with which is referenced by `ansible.cfg`:
```bash
[all]
centos1
```

We can now ping without manually specifying the inventory since it is already set in `ansible.cfg` config file:
```bash
ansible all -m ping
```

![[Pasted image 20230809085427.png]]

This works because we already have `centos1` as a known host. We can also specify `ANSIBLE_HOST_KEY_CHECKING=false` to ignore the fingerprint check when trying to ssh:
```bash
ANSIBLE_HOST_KEY_CHECKING=false ansible all -m ping
```

![[Pasted image 20230809085756.png]]

Or we can set it up in our configuration file:
```bash
[default]
inventory = hosts
host_key_checking = false
```

![[Pasted image 20230809085937.png]]

# Groups

By structuring inventories using explicit groups, we can control what hosts we can actually interact with:
```bash
[centos] # <- explicit group for the centos hosts
centos1
centos2
centos3

[ubuntu] # <- explicit group for the ubuntu hosts
ubuntu1
ubuntu2
ubuntu3
```

We can now ping all, or manually ping specified groups in `[]` identifier:
```bash
ansible ping centos -m ping
```

![[Pasted image 20230809090426.png]]

```bash
ansible ubuntu -m ping
```

![[Pasted image 20230809090504.png]]

We can also ping all hosts using `*` wildcard inside quotation marks:
```bash
ansible '*' -m ping
```

![[Pasted image 20230809090821.png]]

The output always seems too much, we can condense it using the `-o` flag:
```bash
ansible all -m ping -o
```

![[Pasted image 20230809090938.png]]

To figure out which hosts exist in each group, specify the the name of the group followed by `--list-host` flag:
```bash
ansible centos --list-hosts
```

![[Pasted image 20230809091130.png]]

List all hosts:
```bash
ansible all --list-hosts
```

![[Pasted image 20230809091226.png]]

Or and individual host:
```bash
ansible centos1 --list-hosts
```

![[Pasted image 20230809091308.png]]

We can also use regex to specify hosts:
```bash
ansible ~.*3 --list-hosts
```

- `~` specifies that the command will contain a regex
- `.` specify any character
- `*` specify any number of previous characters
- `3` match those that end with `3`

![[Pasted image 20230809091606.png]]

# Elevated Execution

Sometimes, we may need to have elevated access to interact and administer hosts in an inventory, we can set up a variable to specify which user to use when performing actions on remote hosts:
```bash
[centos]
centos1 ansible_user=root
centos2 ansible_user=root
centos3 ansible_user=root

[ubuntu]
ubuntu1
ubuntu2
ubuntu3
```

We can check our ID using the `command` module to run an OS command:
```bash
ansible all -m command -a 'id' -o
```

![[Pasted image 20230809092029.png]]

# Controlled Elevated Execution

However it is overkill to use the root user when interacting with remote hosts, we can use the `ansible_become*` variable to become superuser in hosts that have it set up in:
```bash
[centos]
centos1 ansible_user=root
centos2 ansible_user=root
centos3 ansible_user=root

[ubuntu]
ubuntu1 ansible_become=true ansible_become_pass=password
ubuntu2 ansible_become=true ansible_become_pass=password
ubuntu3 ansible_become=true ansible_become_pass=password
```

![[Pasted image 20230809092450.png]]

# Alternative SSH Port

We can change the config for docker-compose which specifies the SSH port:
```yaml
centos1:
    hostname: centos1
    container_name: centos1
    #image: spurin/diveintoansible:centos <- image with default ssh port 22
    image: spurin/diveintoansible:centos-sshd-2222 
    ports: 
     #- ${CENTOS1_PORT_SSHD}:22 <- disable port 22 for sshd
     - ${CENTOS1_PORT_SSHD}:2222
     - ${CENTOS1_PORT_TTYD}:7681
    privileged: true
    volumes:
     - ${CONFIG}:/config
     - ${ANSIBLE_HOME}/shared:/shared
     - ${ANSIBLE_HOME}/centos1/ansible:/home/ansible
     - ${ANSIBLE_HOME}/centos1/root:/root
    networks:
     - diveinto.io
```

Now, restart docker:
```bash
docker-compose up
```

To communicate with `centos1` host, we need to use a variable `ansible_port` to specify the port for ansible to use when interacting with hosts over SSH:
```bash
[centos]
centos1 ansible_user=root ansible_port=2222
centos2 ansible_user=root
centos3 ansible_user=root

[ubuntu]
ubuntu1 ansible_become=true ansible_become_pass=password
ubuntu2 ansible_become=true ansible_become_pass=password
ubuntu3 ansible_become=true ansible_become_pass=password
```

Now we can communicate with it:
```bash
ansible all -m ping -o
```

![[Pasted image 20230809110146.png]]

We can also refrain using a variable and specify it next to the host name separated by a colon:
```bash
[centos]
centos1:2222 ansible_user=root
centos2 ansible_user=root
centos3 ansible_user=root

[ubuntu]
ubuntu1 ansible_become=true ansible_become_pass=password
ubuntu2 ansible_become=true ansible_become_pass=password
ubuntu3 ansible_become=true ansible_become_pass=password
```

# Control Groups

We can also set up a control group to run modules on the local machine:
```bash
[control]
ubuntu-c ansible_connection=local

[centos]
centos1 ansible_user=root ansible_port=2222
centos2 ansible_user=root
centos3 ansible_user=root

[ubuntu]
ubuntu1 ansible_become=true ansible_become_pass=password
ubuntu2 ansible_become=true ansible_become_pass=password
ubuntu3 ansible_become=true ansible_become_pass=password
```

When we run the ping module:
```bash
ansible all -m ping -o
```

![[Pasted image 20230809110508.png]]

Ansible also runs the module locally

# Ranges

We can set up ranges to specify a certain amount of hosts which ansible will interact with. Since our `centos1` host has a different port, and it's the only one with that, we cannot add it to our range:
```bash
[control]
ubuntu-c ansible_connection=local

[centos]
centos1 ansible_user=root ansible_port=2222
centos[2:3] ansible_user=root

[ubuntu]
ubuntu[1:3] ansible_become=true ansible_become_pass=password
```

We can list the hosts like so:
```bash
ansible all --list-hosts
```

![[Pasted image 20230809111114.png]]

# Group Vars

Since our configuration is getting more and more complicated, we need to structure it to avoid duplicates and readability. We can use Group Vars to be tied to a whole group as so:
```bash
[control]
ubuntu-c ansible_connection=local

[centos]
centos1 ansible_port=2222
centos[2:3]

[centos:vars]
ansible_user=root

[ubuntu]
ubuntu[1:3]

[ubuntu:vars]
ansible_become=true
ansible_become_pass=password
```

We tried this out with a ping:
```bash
ansible all -m ping -o
```

![[Pasted image 20230809111416.png]]

# Children Declaration

We can define a parent group of linux where ubuntu and centos are children:
```bash
[control]
ubuntu-c ansible_connection=local

[centos]
centos1 ansible_port=2222
centos[2:3]

[centos:vars]
ansible_user=root

[ubuntu]
ubuntu[1:3]

[ubuntu:vars]
ansible_become=true
ansible_become_pass=password

[linux:children]
centos
ubuntu
```

We can ping the group specifically, in which it will transition into the respective child groups:
```bash
ansible linux -m ping -o
```

![[Pasted image 20230809113812.png]]

# All Vars

We can set "global" variables using the `[all:vars]` declaration:
```bash
[control]
ubuntu-c ansible_connection=local

[centos]
centos1 ansible_port=2222
centos[2:3]

[centos:vars]
ansible_user=root

[ubuntu]
ubuntu[1:3]

[ubuntu:vars]
ansible_become=true
ansible_become_pass=password

[linux:children]
centos
ubuntu

[all:vars]
ansible_port=1234
```

This will effectively make ansible try to connect to port 1234 which it will think as SSH
```bash
ansible all -m ping -o
```

![[Pasted image 20230809114039.png]]

We can reach `ubuntu-c` and `centos1` hosts because the global reach is not applied since:
- `centos1` has a configuration for port 2222 which takes precedence over the global var
- `ubuntu-c` has the configuration to run locally which also takes precedence over global vars

# Targeted Group Vars

We can also apply group vars to a parent group to apply to all its children:
```bash
[control]
ubuntu-c ansible_connection=local

[centos]
centos1 ansible_port=2222
centos[2:3]

[centos:vars]
ansible_user=root

[ubuntu]
ubuntu[1:3]

[ubuntu:vars]
ansible_become=true
ansible_become_pass=password

[linux:children]
centos
ubuntu

[linux:vars]
ansible_port=1234
```

We can ping as well with the same result for the linux group:
```bash
ansible linux -m ping -o
```

![[Pasted image 20230809114510.png]]

# Config Formats

## Yaml

We can also create config files that use Yaml for formatting:
```yaml
---
control:
  hosts:
    ubuntu-c:
      ansible_connection: local
centos:
  hosts:
    centos1:
      ansible_port: 2222
    centos2:
    centos3:
  vars:
    ansible_user: root
ubuntu:
  hosts:
    ubuntu1:
    ubuntu2:
    ubuntu3:
  vars:
    ansible_become: true
    ansible_become_pass: password
linux:
  children:
    centos:
    ubuntu:
...
```

This still works for ansible to run modules:
```bash
ansible all -m ping -o
```

![[Pasted image 20230809114804.png]]


## JSON

We can also create the equivalent using JSON formatting. First, use python to convert the Yaml config to JSON format:
```bash
python3 -c 'import sys, yaml, json; json.dump(yaml.load(sys.stdin, Loader=yaml.FullLoader), sys.stdout, indent=4)' < hosts.yaml > hosts.json
```

![[Pasted image 20230809115143.png]]

Again if we issue a ping on all hosts, it should work:
```bash
ansible all -m ping -o
```

![[Pasted image 20230809115333.png]]

We can now instruct ansible to use a specific format for interaction with the hosts:
```bash
ansible all -i hosts.json --list-hosts
ansible all -i hosts.json -m ping -o
```

![[Pasted image 20230809115554.png]]

# Extra Vars

We can also use the `-e` flag to specify new or override existing vars from the command line:
```bash
ansible all -m ping -o -e ansible_port=1234
```

![[Pasted image 20230809115828.png]]

