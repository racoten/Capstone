
Playbooks use YAML to define the structure of how it will behave.

Each playbook, apart from the already defined initial structure for YAML files for ansible, begins with a `-` symbol before the playbook and after the 3 `-` symbols at the start of the YAML file.
```yaml
---

# begin playbook, this will indicate a list of items for the plays which will be in dictionaries
-

...
```

# Directives

- `Hosts` - where our play will run and options it will run with
- `Vars` - variables that will apply to the play, on all target systems
- `Tasks` - the list of tasks that will be executed within the play, this section can also be used for pre and post tasks
- `Handlers` - the list of handlers that are executed as a notify key from a task
- `Roles` - list of roles to be imported into the play

# Change MOTD for a Host

We can define a playbook which will take a file name `centos_motd` and copy it to the remote host `/etc/motd` to change the Message of the Day:
```yaml
---

# begin playbook, this will indicate a list of items for the plays which will be in dictionaries
-
	hosts: centos
	user: root # we can overwrite the user applied
	tasks:
		- name: Configure a MOTD
		  copy:
			  src: centos_motd
			  dest: /etc/motd
...
```

We can execute this playbook like so:
```bash
ansible-playbook motd_playbook.yaml
```

![[Pasted image 20230810004527.png]]

You see that 2 tasks are executed because the first one, by default, is that one that gathers facts about the hosts. And the second one is the actual playbook task defined

You can ommit the first step with:
```yaml
gather_facts: False
```

Before specifying the tasks.
![[Pasted image 20230810005952.png]]
![[Pasted image 20230810005926.png]]

It is also possible to provide content instead of a source file to be copied to a remote host:
```yaml
copy:
	content: Ansible Rocks Man
    dest: /etc/motd
```

We can now try this:
```bash
ansible-playbook motd_playbook.yaml
```

![[Pasted image 20230810121012.png]]

## Vars

It is trivial to work with vars since you only need to place them inside `{{ }}`:
```yaml
vars:
    motd: "Ansible Rocks\n"

  # Tasks: the list of tasks that will be executed within the playbook
  tasks:
    - name: Configure a MOTD (message of the day)
      copy:
        content: "{{ motd }}"
        dest: /etc/motd
```

![[Pasted image 20230810121248.png]]

Even more flexible is the fact that we can modify variables, and this will take precedence, when we run the command using the `-e` flag:
```bash
ansible-playbook motd_playbook.yaml -e 'motd="Testing for CLI Variable Change\n"'
```

![[Pasted image 20230810121611.png]]

## Handlers

Handlers will execute once a task is finished on every host the playbook is targeting. We can define a Handler after defining a Task:
```yaml
# Hosts: where our play will run and options it will run with
  hosts: centos
  user: root
  gather_facts: False

  # Vars: variables that will apply to the play, on all target systems
  vars:
    motd: "Welcome to CentOS Linux - Ansible Rocks\n"

  # Tasks: the list of tasks that will be executed within the playbook
  tasks:
    - name: Configure a MOTD (message of the day)
      copy:
        content: "{{ motd }}"
        dest: /etc/motd
      notify: MOTD changed

  # Handlers: the list of handlers that are executed as a notify key from a task
  handlers:
    - name: MOTD changed
      debug:
        msg: The MOTD was changed
```

When we execute this playbook, we should see a notification that the playbook was executed:
```bash
ansible-playbook motd_playbook.yaml
```

![[Pasted image 20230810121933.png]]

And indeed the contents of each files was changed:

![[Pasted image 20230810122000.png]]

Another way to verify if the task completed successfully, is to run the playbook again and expect all green recaps and no notification:

![[Pasted image 20230810122130.png]]

# Decision Structure

It is possible to work with a similar "If Statement" in the YAML config using the `when` directive.

This directive will have ansible make a decision to execute the task if it returns True, otherwise, it will not.

We can have ansible make a decision to run the task if the Linux distribution is CentOS or Ubuntu like so:
```yaml
# Vars: variables that will apply to the play, on all target systems
  vars:
    motd_centos: "Welcome to CentOS Linux - Ansible Rocks\n"
    motd_ubuntu: "Welcome to Ubuntu Linux - Ansible Rocks\n"
 
  # Tasks: the list of tasks that will be executed within the playbook
  tasks:
    - name: Configure a MOTD (message of the day)
      copy:
        content: "{{ motd_centos }}"
        dest: /etc/motd
      notify: MOTD changed
      when: ansible_distribution == "CentOS"

    - name: Configure a MOTD (message of the day)
      copy:
        content: "{{ motd_ubuntu }}"
        dest: /etc/motd
      notify: MOTD changed
      when: ansible_distribution == "Ubuntu"
 
  # Handlers: the list of handlers that are executed as a notify key from a task
  handlers:
    - name: MOTD changed
      debug:
        msg: The MOTD was changed
```

The `ansible_distribution` is a global variable of ansible that is initialized when it interacts with a host. We can first check this variable using the `setup` module:
```bash
ansible all -i centos2,ubuntu1 -m setup | grep ansible_distribution
```

![[Pasted image 20230810123024.png]]

Since our immediate access to ubuntu is not root, we need to specify it as a group which is defined in the config file `hosts`:
```bash
[control]
ubuntu-c ansible_connection=local

[centos]
centos1 ansible_port=2222
centos[2:3]

[centos:vars]
ansible_user=root

[ubuntu]
ubuntu[1:3]

[ubuntu:vars]
ansible_become=true
ansible_become_pass=password

[linux:children]
centos
ubuntu
```

We add the following line at the top of the playbook:
```yaml
hosts: linux
```

#### Note

Remove the `gather_facts: False` line from the playbook because we need to gather the information so that `ansible_distribution` can be used for the playbook.

We now use the playbook as administrator for all hosts:
```bash
ansible-playbook motd_playbook.yaml
```

![[Pasted image 20230810123510.png]]

Notice `skipping` in the output, this signifies that `when` successfully detected the distribution and ansible made a decision to not run the task on that host.

# Challenge

1. Change to the challenge directory, and either create or copy the `ansible.cfg` and `hosts` file. Check that our hosts are reachable using the `ansible` command
2. Copy the `motd_playbook.yaml` template from revision 01
3. Update the playbook, to target the ubuntu group
4. Add a `Handler` that will debug, if there is a change
5. Create a `task`, that copies the file in the current directory, `60-ansible-motd`, to `/etc/update-motd.d/60-ansible-motd`
	- Use the `option` mode, for copy, to set permissions to preserve
6. Add a notify option to the task to inform of changes

## Playbook:

```yaml
---
# YAML documents begin with the document separator ---

# The minus in YAML this indicates a list item.  The playbook contains a list 
# of plays, with each play being a dictionary
-

  # Hosts: where our play will run and options it will run with
  hosts: ubuntu
  gather_facts: False
  # Vars: variables that will apply to the play, on all target systems

  # Tasks: the list of tasks that will be executed within the play, this section
  #       can also be used for pre and post tasks
  tasks:
    - name: Configure the MOTD script
      copy:
        src: 60-ansible-motd
        dest: /etc/update-motd.d/60-ansible-motd
        mode: preserve
      notify: MOTD Script Change
  # Handlers: the list of handlers that are executed as a notify key from a task
  handlers:
    - name: MOTD Script Change
      debug:
        msg: The MOTD Script has been Uploaded
  # Roles: list of roles to be imported into the play

# Three dots indicate the end of a YAML document
...
```

![[Pasted image 20230810132310.png]]

![[Pasted image 20230810132540.png]]