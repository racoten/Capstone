Facts are a collection of information gathered by ansible.

They can be attributed to a host which will describe it.

# ansible_facts
We can gather specific facts by using `gather_subset` from a host or a group of hosts:
```bash
ansible centos1 -m setup -a 'gather_subset=network' | more
```

![[Pasted image 20230813124558.png]]

We can also filter output for specific facts:
```bash
ansible centos1 -m setup -a 'filter=ansible_memfree_mb'
```

![[Pasted image 20230813124619.png]]

It's also possible to use a wildcard:
```bash
ansible centos1 -m setup -a 'filter=ansible_mem*'
```

![[Pasted image 20230813134357.png]]

It is possible to access facts directly through the root, we can do this with a playbook:
```yaml
---
# YAML documents begin with the document separator ---
 
# The minus in YAML this indicates a list item.  The playbook contains a list
# of plays, with each play being a dictionary
-
 
  # Hosts: where our play will run and options it will run with
  hosts: all

  # Tasks: the list of tasks that will be executed within the play, this section
  # can also be used for pre and post tasks
  tasks:
    - name: Show IP Address
      debug:
        msg: "{{ ansible_default_ipv4.address }}"

# Three dots indicate the end of a YAML document
...
```

![[Pasted image 20230813134731.png]]


# Custom Facts

They can be written in any language that can return a JSON structure or an ini structure

![[Pasted image 20230813135112.png]]

First, create the default setup to work with custom facts:
```bash
sudo mkdir -p /etc/ansible/facts.d
sudo cp *.fact /etc/ansible/facts.d
```

The fact files only exist in the control host hence it will not work for any other host:
```bash
ansible ubuntu-c -m setup | more
```

![[Pasted image 20230813135923.png]]

We can filter all the noise from the `setup` module to only include our custom fact:
```bash
ansible ubuntu-c -m setup -a 'filter=ansible_local'
```

![[Pasted image 20230813204750.png]]


# Interacting with Custom Facts

We can interact with our custom facts like variables. Recall `ansible_local` has a structure within which we can get data from:
```yaml
---
# YAML documents begin with the document separator ---

# The minus in YAML this indicates a list item.  The playbook contains a list
# of plays, with each play being a dictionary
-

  # Hosts: where our play will run and options it will run with
  hosts: all

  # Tasks: the list of tasks that will be executed within the play, this section
  # can also be used for pre and post tasks
  tasks:
    - name: Show IP Address
      debug:
        msg: "{{ ansible_default_ipv4.address }}"

    - name: Show Custom Fact 1
      debug:
        msg: "{{ ansible_local.getdate1.date }}"

    - name: Show Custom Fact 2
      debug:
        msg: "{{ ansible_local.getdate2.date.date }}"

# Three dots indicate the end of a YAML document
...
```

We can use them as we would use variables and access them like we would dictionaries or lists:
```bash
ansible-playbook facts_playbook.yaml
```

![[Pasted image 20230813205115.png]]

Since our custom fact only resides in our local controller, it only shows up in that host.

For more control of the output, ansible offers the `-l` flag to limit output to a specific pattern in a host or list of hosts
```bash
ansible-playbook facts_playbook.yaml -l ubuntu-c
```

![[Pasted image 20230813210847.png]]

Since these custom facts will exist inside a host, we can also access them via the `hostvars`:
```yaml
---
# YAML documents begin with the document separator ---

# The minus in YAML this indicates a list item.  The playbook contains a list
# of plays, with each play being a dictionary
-

  # Hosts: where our play will run and options it will run with
  hosts: all

  # Tasks: the list of tasks that will be executed within the play, this section
  # can also be used for pre and post tasks
  tasks:
    - name: Show IP Address
      debug:
        msg: "{{ ansible_default_ipv4.address }}"

    - name: Show Custom Fact 1
      debug:
        msg: "{{ ansible_local.getdate1.date }}"

    - name: Show Custom Fact 2
      debug:
        msg: "{{ ansible_local.getdate2.date.date }}"

    - name: Show Custom Fact 1 in hostvars
      debug:
        msg: "{{ hostvars[ansible_hostname].ansible_local.getdate1.date }}"

    - name: Show Custom Fact 2 in hostvars
      debug:
        msg: "{{hostvars[ansible_hostname].ansible_local.getdate2.date.date }}"

# Three dots indicate the end of a YAML document
...
```

![[Pasted image 20230813211021.png]]


# Propagating our Custom Facts

We can copy our custom facts to remote hosts using the `copy` module in our playbook. Afterwards, we refresh the Facts by calling the `setup` module again:
```yaml
---
# YAML documents begin with the document separator ---

# The minus in YAML this indicates a list item.  The playbook contains a list
# of plays, with each play being a dictionary
-

  # Hosts: where our play will run and options it will run with
  hosts: linux

  # Tasks: the list of tasks that will be executed within the play, this section
  # can also be used for pre and post tasks
  tasks:

    - name: Make Facts Dir
      file:
        path: /etc/ansible/facts.d
        recurse: yes
        state: directory

    - name: Copy Fact 1
      copy:
        src: /etc/ansible/facts.d/getdate1.fact
        dest: /etc/ansible/facts.d/getdate1.fact
        mode: 0755

    - name: Copy Fact 2
      copy:
        src: /etc/ansible/facts.d/getdate2.fact
        dest: /etc/ansible/facts.d/getdate2.fact
        mode: 0755

    - name: Refresh Facts
      setup:

    - name: Show IP Address
      debug:
        msg: "{{ ansible_default_ipv4.address }}"

    - name: Show Custom Fact 1
      debug:
        msg: "{{ ansible_local.getdate1.date }}"

    - name: Show Custom Fact 2
      debug:
        msg: "{{ ansible_local.getdate2.date.date }}"

    - name: Show Custom Fact 1 in hostvars
      debug:
        msg: "{{ hostvars[ansible_hostname].ansible_local.getdate1.date }}"

    - name: Show Custom Fact 2 in hostvars
      debug:
        msg: "{{hostvars[ansible_hostname].ansible_local.getdate2.date.date }}"

# Three dots indicate the end of a YAML document
...
```

First, our tasks to work the file into the hosts is run:

![[Pasted image 20230813211356.png]]

Then, we can actually access the facts in each hosts:

![[Pasted image 20230813211507.png]]![[Pasted image 20230813211536.png]]

Instead of reloading all facts, we can have ansible reload our custom facts:
```yaml
---
# YAML documents begin with the document separator ---

# The minus in YAML this indicates a list item.  The playbook contains a list
# of plays, with each play being a dictionary
-

  # Hosts: where our play will run and options it will run with
  hosts: linux

  # Tasks: the list of tasks that will be executed within the play, this section
  # can also be used for pre and post tasks
  tasks:

    - name: Make Facts Dir
      file:
        path: /home/ansible/facts.d
        recurse: yes
        state: directory
        owner: ansible

    - name: Copy Fact 1
      copy:
        src: facts.d/getdate1.fact
        dest: /home/ansible/facts.d/getdate1.fact
        owner: ansible
        mode: 0755

    - name: Copy Fact 2
      copy:
        src: facts.d/getdate2.fact
        dest: /home/ansible/facts.d/getdate2.fact
        owner: ansible
        mode: 0755

    - name: Reload Facts
      setup:
        fact_path: /home/ansible/facts.d

    - name: Show IP Address
      debug:
        msg: "{{ ansible_default_ipv4.address }}"

    - name: Show Custom Fact 1
      debug:
        msg: "{{ ansible_local.getdate1.date }}"

    - name: Show Custom Fact 2
      debug:
        msg: "{{ ansible_local.getdate2.date.date }}"

    - name: Show Custom Fact 1 in hostvars
      debug:
        msg: "{{ hostvars[ansible_hostname].ansible_local.getdate1.date }}"

    - name: Show Custom Fact 2 in hostvars
      debug:
        msg: "{{hostvars[ansible_hostname].ansible_local.getdate2.date.date }}"

# Three dots indicate the end of a YAML document
...
```

![[Pasted image 20230813212141.png]]![[Pasted image 20230813212207.png]]
![[Pasted image 20230813212225.png]]

We can now remove the `facts.d` directory from all systems:
```bash
ansible linux -m file -a 'path=/etc/ansible/facts.d state=absent'
```

![[Pasted image 20230813212435.png]]